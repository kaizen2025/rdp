# docker-compose.yml - VERSION FINALE AVEC AUTHENTIFICATION PAR TOKEN (JSON)

services:
  guacd:
    image: guacamole/guacd:1.5.3 # Fixer les versions est une bonne pratique
    container_name: rds-viewer-guacd
    restart: unless-stopped
    volumes:
      # Optionnel: pour le partage de fichiers dans la session RDP
      - ./guacamole-drive:/drive:rw 
    networks:
      - guacamole-network

  mysql:
    image: mysql:8.0
    container_name: rds-viewer-mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: "guacamole_root_pass" # Mot de passe pour l'admin de la BDD
      MYSQL_DATABASE: guacamole_db
      MYSQL_USER: guacamole_user
      MYSQL_PASSWORD: "guacamole_pass" # Mot de passe pour l'utilisateur Guacamole dans la BDD
    volumes:
      - mysql-data:/var/lib/mysql
      # Le script d'init est crucial pour créer la structure de la BDD au premier lancement
      - ./guacamole-init:/docker-entrypoint-initdb.d:ro
    networks:
      - guacamole-network

  guacamole:
    image: guacamole/guacamole:1.5.3 # Utiliser la même version que l'extension
    container_name: rds-viewer-guacamole
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      GUACD_HOSTNAME: rds-viewer-guacd
      GUACD_PORT: 4822
      MYSQL_DATABASE: guacamole_db
      MYSQL_HOSTNAME: rds-viewer-mysql
      MYSQL_PORT: 3306
      MYSQL_USER: guacamole_user
      MYSQL_PASSWORD: "guacamole_pass" # Doit correspondre à celui de la BDD
      
      # --- CONFIGURATION DE L'AUTHENTIFICATION PAR TOKEN ---
      # Activer l'authentification de base (MySQL) ET l'authentification par token JSON
      EXTENSIONS: "auth-jdbc-mysql, auth-json"
      
      # Clé secrète pour signer les tokens (doit correspondre à celle dans config.json)
      JSON_SECRET_KEY: "PBWmJHC2mKfvSUtc7eG7/d/QpPmeBrTAq9L6EgQHy+w="
      
      # Durée de validité de la signature du token en secondes (60s est une bonne valeur)
      JSON_TIMESTAMP_AGE_LIMIT: "60"

    volumes:
      # Monter le dossier contenant le .jar de l'extension
      # Assurez-vous que le fichier guacamole-auth-json-1.5.3.jar est dans ce dossier
      - ./guacamole-extensions:/opt/guacamole/extensions
    
    depends_on:
      - guacd
      - mysql
    networks:
      - guacamole-network

networks:
  guacamole-network:
    driver: bridge

volumes:
  mysql-data: